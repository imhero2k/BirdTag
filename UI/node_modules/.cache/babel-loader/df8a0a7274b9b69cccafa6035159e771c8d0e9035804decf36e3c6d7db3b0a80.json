{"ast":null,"code":"import React,{useState}from'react';import{fetchAuthSession}from'aws-amplify/auth';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const supportedTypes=['image/jpeg','image/jpg','image/png','image/gif','image/webp','video/mp4','video/mov','video/avi','video/quicktime','audio/mpeg','audio/mp3','audio/wav','audio/ogg','audio/m4a'];// Utility: SHA-256 hash of file contents\nconst getFileHash=async file=>{const arrayBuffer=await file.arrayBuffer();const hashBuffer=await crypto.subtle.digest('SHA-256',arrayBuffer);const hashArray=Array.from(new Uint8Array(hashBuffer));return hashArray.map(b=>b.toString(16).padStart(2,'0')).join('');};const Upload=()=>{const[selectedFile,setSelectedFile]=useState(null);const[message,setMessage]=useState('');const[progress,setProgress]=useState(0);const[isUploading,setIsUploading]=useState(false);const handleFileChange=e=>{const file=e.target.files[0];setSelectedFile(file);setProgress(0);setMessage('');};const handleUpload=async()=>{if(!selectedFile){setMessage('Please select a file.');return;}if(!supportedTypes.includes(selectedFile.type)){setMessage('Unsupported file type.');return;}try{var _tokens$idToken;setIsUploading(true);// 1. Compute hashed file name\nconst fileHash=await getFileHash(selectedFile);const ext=selectedFile.name.split('.').pop();const hashedFileName=\"\".concat(fileHash,\".\").concat(ext);console.log(\"Hashed file name:\",hashedFileName);// 2. Get Cognito token\nconst{tokens}=await fetchAuthSession();const idToken=tokens===null||tokens===void 0?void 0:(_tokens$idToken=tokens.idToken)===null||_tokens$idToken===void 0?void 0:_tokens$idToken.toString();// 3. Get presigned upload URL\nconst uploadRes=await fetch('https://5myucif3s8.execute-api.us-east-1.amazonaws.com/dev/upload',{method:'POST',headers:{'Content-Type':'application/json','Authorization':\"Bearer \".concat(idToken)},body:JSON.stringify({fileName:hashedFileName,fileType:selectedFile.type})});const json=await uploadRes.json();if(uploadRes.status!==200||!json.uploadUrl){setMessage(json.message||'Upload request failed.');return;}// 4. Upload to S3 with progress\nawait new Promise((resolve,reject)=>{const xhr=new XMLHttpRequest();xhr.open('PUT',json.uploadUrl,true);xhr.setRequestHeader('Content-Type',selectedFile.type);xhr.upload.onprogress=event=>{if(event.lengthComputable){const percent=Math.round(event.loaded/event.total*100);setProgress(percent);}};xhr.onload=()=>{if(xhr.status===200){resolve();}else{reject(new Error(\"S3 upload failed: \".concat(xhr.statusText)));}};xhr.onerror=()=>reject(new Error('S3 upload failed due to a network error.'));xhr.send(selectedFile);});setMessage('Upload successful!');setSelectedFile(null);}catch(error){console.error('Upload failed:',error);setMessage('Upload failed. Check console for details.');}finally{setIsUploading(false);}};return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h2\",{children:\"Upload File\"}),/*#__PURE__*/_jsx(\"input\",{type:\"file\",onChange:handleFileChange}),/*#__PURE__*/_jsx(\"button\",{onClick:handleUpload,disabled:isUploading,style:{marginLeft:'10px'},children:isUploading?'Uploading...':'Upload'}),progress>0&&/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:'20px'},children:[/*#__PURE__*/_jsx(\"div\",{style:{width:'100%',maxWidth:'400px',height:'20px',backgroundColor:'#e0e0e0',borderRadius:'10px',overflow:'hidden',boxShadow:'inset 0 1px 3px rgba(0,0,0,0.2)',marginBottom:'8px'},children:/*#__PURE__*/_jsx(\"div\",{style:{height:'100%',width:\"\".concat(progress,\"%\"),backgroundColor:progress===100?'#4caf50':'#2196f3',transition:'width 0.2s ease-in-out'}})}),/*#__PURE__*/_jsxs(\"p\",{children:[progress,\"%\"]})]}),message&&/*#__PURE__*/_jsx(\"p\",{style:{marginTop:'10px'},children:message})]});};export default Upload;","map":{"version":3,"names":["React","useState","fetchAuthSession","jsx","_jsx","jsxs","_jsxs","supportedTypes","getFileHash","file","arrayBuffer","hashBuffer","crypto","subtle","digest","hashArray","Array","from","Uint8Array","map","b","toString","padStart","join","Upload","selectedFile","setSelectedFile","message","setMessage","progress","setProgress","isUploading","setIsUploading","handleFileChange","e","target","files","handleUpload","includes","type","_tokens$idToken","fileHash","ext","name","split","pop","hashedFileName","concat","console","log","tokens","idToken","uploadRes","fetch","method","headers","body","JSON","stringify","fileName","fileType","json","status","uploadUrl","Promise","resolve","reject","xhr","XMLHttpRequest","open","setRequestHeader","upload","onprogress","event","lengthComputable","percent","Math","round","loaded","total","onload","Error","statusText","onerror","send","error","children","onChange","onClick","disabled","style","marginLeft","marginTop","width","maxWidth","height","backgroundColor","borderRadius","overflow","boxShadow","marginBottom","transition"],"sources":["/Users/saisaran/Desktop/BirdTag/UI/src/Upload.js"],"sourcesContent":["\r\n\r\nimport React, { useState } from 'react';\r\nimport { fetchAuthSession } from 'aws-amplify/auth';\r\n\r\nconst supportedTypes = [\r\n  'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp',\r\n  'video/mp4', 'video/mov', 'video/avi', 'video/quicktime',\r\n  'audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/ogg', 'audio/m4a'\r\n];\r\n\r\n// Utility: SHA-256 hash of file contents\r\nconst getFileHash = async (file) => {\r\n  const arrayBuffer = await file.arrayBuffer();\r\n  const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);\r\n  const hashArray = Array.from(new Uint8Array(hashBuffer));\r\n  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');\r\n};\r\n\r\nconst Upload = () => {\r\n  const [selectedFile, setSelectedFile] = useState(null);\r\n  const [message, setMessage] = useState('');\r\n  const [progress, setProgress] = useState(0);\r\n  const [isUploading, setIsUploading] = useState(false);\r\n\r\n  const handleFileChange = (e) => {\r\n    const file = e.target.files[0];\r\n    setSelectedFile(file);\r\n    setProgress(0);\r\n    setMessage('');\r\n  };\r\n\r\n  const handleUpload = async () => {\r\n    if (!selectedFile) {\r\n      setMessage('Please select a file.');\r\n      return;\r\n    }\r\n\r\n    if (!supportedTypes.includes(selectedFile.type)) {\r\n      setMessage('Unsupported file type.');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setIsUploading(true);\r\n\r\n      // 1. Compute hashed file name\r\n      const fileHash = await getFileHash(selectedFile);\r\n      const ext = selectedFile.name.split('.').pop();\r\n      const hashedFileName = `${fileHash}.${ext}`;\r\n      console.log(\"Hashed file name:\", hashedFileName);\r\n\r\n      // 2. Get Cognito token\r\n      const { tokens } = await fetchAuthSession();\r\n      const idToken = tokens?.idToken?.toString();\r\n\r\n      // 3. Get presigned upload URL\r\n      const uploadRes = await fetch('https://5myucif3s8.execute-api.us-east-1.amazonaws.com/dev/upload', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${idToken}`\r\n        },\r\n        body: JSON.stringify({\r\n          fileName: hashedFileName,\r\n          fileType: selectedFile.type\r\n        })\r\n      });\r\n\r\n      const json = await uploadRes.json();\r\n      if (uploadRes.status !== 200 || !json.uploadUrl) {\r\n        setMessage(json.message || 'Upload request failed.');\r\n        return;\r\n      }\r\n\r\n      // 4. Upload to S3 with progress\r\n      await new Promise((resolve, reject) => {\r\n        const xhr = new XMLHttpRequest();\r\n        xhr.open('PUT', json.uploadUrl, true);\r\n        xhr.setRequestHeader('Content-Type', selectedFile.type);\r\n\r\n        xhr.upload.onprogress = (event) => {\r\n          if (event.lengthComputable) {\r\n            const percent = Math.round((event.loaded / event.total) * 100);\r\n            setProgress(percent);\r\n          }\r\n        };\r\n\r\n        xhr.onload = () => {\r\n          if (xhr.status === 200) {\r\n            resolve();\r\n          } else {\r\n            reject(new Error(`S3 upload failed: ${xhr.statusText}`));\r\n          }\r\n        };\r\n\r\n        xhr.onerror = () => reject(new Error('S3 upload failed due to a network error.'));\r\n        xhr.send(selectedFile);\r\n      });\r\n\r\n      setMessage('Upload successful!');\r\n      setSelectedFile(null);\r\n    } catch (error) {\r\n      console.error('Upload failed:', error);\r\n      setMessage('Upload failed. Check console for details.');\r\n    } finally {\r\n      setIsUploading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div>\r\n      <h2>Upload File</h2>\r\n      <input type=\"file\" onChange={handleFileChange} />\r\n      <button onClick={handleUpload} disabled={isUploading} style={{ marginLeft: '10px' }}>\r\n        {isUploading ? 'Uploading...' : 'Upload'}\r\n      </button>\r\n\r\n      {progress > 0 && (\r\n        <div style={{ marginTop: '20px' }}>\r\n          <div style={{\r\n            width: '100%',\r\n            maxWidth: '400px',\r\n            height: '20px',\r\n            backgroundColor: '#e0e0e0',\r\n            borderRadius: '10px',\r\n            overflow: 'hidden',\r\n            boxShadow: 'inset 0 1px 3px rgba(0,0,0,0.2)',\r\n            marginBottom: '8px'\r\n          }}>\r\n            <div style={{\r\n              height: '100%',\r\n              width: `${progress}%`,\r\n              backgroundColor: progress === 100 ? '#4caf50' : '#2196f3',\r\n              transition: 'width 0.2s ease-in-out'\r\n            }} />\r\n          </div>\r\n          <p>{progress}%</p>\r\n        </div>\r\n      )}\r\n\r\n      {message && <p style={{ marginTop: '10px' }}>{message}</p>}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Upload;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}